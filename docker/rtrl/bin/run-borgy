#!/usr/bin/env bash

set -e # exit in case somethings fails
# set -x

JOBID=e$(echo $BORGY_JOB_ID | tr - _)  # prepend "e" and replace dashes with underscore

for i in $EXPERIMENTS/$JOBID*; do
  python -m rtrl make_and_run "$i/spec.json" "$i/state" &>> "$i/output.txt" &
  echo training process writing to "$i/output.txt"
done

for i in $EXPERIMENTS/$JOBID*; do wait -n; done
echo all processes exited successfully


test_run_borgy(){
  mkdir /app/exp
  export EXPERIMENTS=/app/exp
  export BORGY_JOB_ID=63030777-c34f-47ef-9e5c-3058ebe1cf5a
  mkdir /app/exp/e63030777_c34f_47ef_9e5c_3058ebe1cf5a_1
  python -m rtrl spec 'partial(Training, epochs=2, Env=partial(id="Reacher-v2"))' /app/exp/e63030777_c34f_47ef_9e5c_3058ebe1cf5a_1/spec.json
  run-borgy
}